@page "/signalr"
@using Microsoft.AspNetCore.SignalR
@using web.Data
@using System.Text.Json
@inject IHubContext<ChatHub> _hubContext;
@inject IJSRuntime _jsRuntime;

<PageTitle>Signal R</PageTitle>

<MatH3>Signal R</MatH3>
<MatH6>Connected as @_userName</MatH6>

<div class="mat-layout-grid mat-layout-grid-align-left" style="max-width: 800px;">
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell">
            <MatButton Raised="true" OnClick="SendNewMessage">Send A New Message</MatButton>
        </div>
    </div>
    <br/>
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell">
            <MatChipSet Filter="true" @bind-SelectedChips="_selectedGroups">
                @foreach (var group in Users.Groups)
                {
                    <MatChip Label="@group" IsCheckable="true"></MatChip>
                }
            </MatChipSet>
        </div>
        <div class="mat-layout-grid-cell">
            <MatButton Raised="true" OnClick="SendGroupMessage">Send A Group Message</MatButton>
        </div>
    </div>
</div>

<ul class="mdc-list" style="" aria-orientation="vertical" id="messageEvents">

</ul>

@code {

    private Task SendNewMessage()
    {
        return _hubContext.Clients.All.SendAsync("broadcastMessage", new Message
        {
            Date = DateTimeOffset.UtcNow,
            Text = $"Hello from {_userName} {Guid.NewGuid()}"
        });
    }

    private async Task SendGroupMessage()
    {
        if (_selectedGroups is null)
        {
            return;
        }

        var tasks = _selectedGroups
            .Select(x => _hubContext.Clients.Group(x.Label).SendAsync("broadcastMessage", new Message()
            {
                Date = DateTimeOffset.UtcNow,
                Text = $"Hello Group {x.Label} from {_userName}"
            }));

        await Task.WhenAll(tasks);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var result = await _jsRuntime.InvokeAsync<JsonElement>("window.signalrPlayGroundContext");
            _userName = result.GetProperty("userName").GetString();
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private string? _userName;
    private MatChip[]? _selectedGroups;
}