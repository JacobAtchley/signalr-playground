@page "/signalr"
@using Microsoft.AspNetCore.SignalR
@using web.Data
@using System.Text.Json
@inject IHubContext<ChatHub> _hubContext;
@inject IJSRuntime _jsRuntime;

<PageTitle>Signal R</PageTitle>

<MatH3>Signal R</MatH3>
<MatH6>Connected as @_userName</MatH6>

<div class="mat-layout-grid mat-layout-grid-align-left" style="max-width: 800px;">
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell">
            <MatButton Raised="true" OnClick="SendNewMessage">Send A New Message</MatButton>
        </div>
    </div>
    <br/>
    <div class="mat-layout-grid-inner">
        <div class="mat-layout-grid-cell">
            <MatSelect Label="Select Group" @bind-Value="_selectedGroup">
                @foreach (var group in Users.Groups)
                {
                    <MatOption TValue="string" Value="group">@group</MatOption>
                }
            </MatSelect>
        </div>
        <div class="mat-layout-grid-cell">
            <MatButton Raised="true" OnClick="SendGroupMessage">Send A Group Message</MatButton>
        </div>
    </div>
</div>

<ul class="mdc-list" style="" aria-orientation="vertical" id="messageEvents">

</ul>

@code {

    private Task SendNewMessage()
    {
        return _hubContext.Clients.All.SendAsync("broadcastMessage", new Message
        {
            Date = DateTimeOffset.UtcNow,
            Text = $"Hello from {_userName} {Guid.NewGuid()}"
        });
    }

    private Task SendGroupMessage()
    {
        if (string.IsNullOrWhiteSpace(_selectedGroup))
        {
            return Task.CompletedTask;
        }

        Console.WriteLine($"Sending message to group {_selectedGroup}");

        return _hubContext.Clients.Group(_selectedGroup).SendAsync("broadcastMessage", new Message
        {
            Date = DateTimeOffset.UtcNow,
            Text = $"Hello Group {_selectedGroup} {Guid.NewGuid()}"
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var result = await _jsRuntime.InvokeAsync<JsonElement>("window.signalrPlayGroundContext");
            _userName = result.GetProperty("userName").GetString();
            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private string? _selectedGroup;
    private string? _userName;
}